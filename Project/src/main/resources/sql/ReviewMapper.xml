<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="test.dao.ReviewDao">
  <resultMap type="review" id="reviewMap">
    <id column="rbno" property="reviewboardno"/> 
    <result column="tmno" property="travelno"/>
    <result column="mno" property="memberno"/> 
    <result column="mnm" property="membername"/>
    <result column="title" property="title"/>
    <result column="cont" property="content"/>
    <result column="cre_dt" property="createdDate"/>
    <result column="vw_cnt" property="viewcount"/>
    <result column="count(c.rbno)" property="commentCount"/>
  </resultMap>
  
  
  <select id="selectList" resultMap="reviewMap" parameterType="map">
    select r.rbno,r.tmno,r.mno,m.mnm,r.title,r.cont,date_format(r.cre_dt,'%Y-%m-%d') as cre_dt ,r.vw_cnt , count(c.rbno)
    from tvl_review_bods r
	inner join tvl_membs m 
	on r.mno=m.mno
	left join tvl_review_comt c
	on r.rbno=c.rbno
	group by r.rbno
 	order by rbno desc  
 	
 	limit #{startIndex}, #{length}
  </select>
  
  <select id="selectOne" resultMap="reviewMap" parameterType="int">
    select  rbno,tmno,r.mno,mnm,title,cont,cre_dt,vw_cnt
    from tvl_review_bods r
	inner join tvl_membs m 
	on r.mno=m.mno
    where rbno = #{value}
  </select>
  
  <select id="detailReviewList" resultMap="reviewMap" parameterType="int">
    select r.rbno,r.tmno,r.mno,m.mnm,r.title,r.cont,r.cre_dt,r.vw_cnt , count(c.rbno)
    from tvl_review_bods r
	inner join tvl_membs m 
	on r.mno=m.mno
	left join tvl_review_comt c
	on r.rbno=c.rbno
	where tmno=#{value}
	group by r.rbno
 	order by rbno desc  
 	
  </select>
  
  <select id="selectOneByMember" resultMap="reviewMap" parameterType="int">
    select  rbno,tmno,r.mno,mnm,title,cont,cre_dt
    from tvl_review_bods r 
    inner join tvl_membs m
    on r.mno=m.mno
    where r.mno = #{value}
    order by rbno desc
  </select>
  
  <select id="selectOneByPassword" resultMap="reviewMap" parameterType="map">
    select no,title,conts,cre_dt,vw_cnt 
    from boards 
    where no=#{no} and password=password(#{password})
  </select>
  
  <insert id="insert"  parameterType="review" useGeneratedKeys="true" keyProperty="reviewboardno" keyColumn="rbno">
    insert into tvl_review_bods(tmno,mno,title, cont, cre_dt,vw_cnt)
    values(#{travelno},#{memberno},#{title}, #{content},  now(),0)
  </insert>
  
  <update id="update" parameterType="review">
    update tvl_review_bods set 
      title=#{title}, 
      cont=#{content} 
    where rbno=#{reviewboardno}
  </update>
  
  <update id="viewCountUpdate" parameterType="int">
    update tvl_review_bods set 
      vw_cnt=vw_cnt+1
    	where rbno=#{reviewboardno}
  </update>
  
  <delete id="delete" parameterType="int">
    delete from tvl_review_bods 
    where rbno=#{value}
  </delete>
  
  <select id="countAll" resultType="int">
    select  count(*)
    from tvl_review_bods 
  </select>
</mapper>




















